<!DOCTYPE html>
<html>
<head>
    <title>ESP32系统测试 (最终版)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>ESP32系统测试 (最终版)</h1>
    
    <div>
        <h3>连接测试</h3>
        <button onclick="testConnection()">测试API连接</button>
        <div id="connectionStatus" class="status"></div>
    </div>

    <div>
        <h3>系统状态</h3>
        <button onclick="getSystemStatus()">获取系统状态</button>
        <div id="systemStatus" class="status"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.innerHTML = message;
        }

        async function testConnection() {
            try {
                showStatus('connectionStatus', '正在连接...', 'info');
                const response = await fetch(`${API_BASE}/test`);
                const data = await response.json();
                showStatus('connectionStatus', 
                    `✅ 连接成功: ${data.message}`, 'success');
            } catch (error) {
                showStatus('connectionStatus', 
                    `❌ 连接失败: ${error}<br><br>
                    确保:<br>
                    1. 已运行命令: python web_server.py<br>
                    2. 服务器终端没有报错<br>
                    3. 尝试使用Chrome浏览器`, 
                    'error');
                console.error('连接错误详情:', error);
            }
        }

        async function getSystemStatus() {
            try {
                showStatus('systemStatus', '获取中...', 'info');
                const response = await fetch(`${API_BASE}/status`);
                const data = await response.json();
                let html = `
                    <strong>系统状态</strong>: ${data.data.system_status}<br>
                    <strong>MQTT连接</strong>: ${data.data.mqtt_connected ? '✅' : '❌'}<br>
                    <strong>IO1状态</strong>: ${data.data.io1_current_state ? '开启' : '关闭'}
                `;
                showStatus('systemStatus', html, 'success');
            } catch (error) {
                showStatus('systemStatus', 
                    `获取状态失败: ${error}`, 'error');
            }
        }
    </script>
</body>
</html>