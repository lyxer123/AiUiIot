<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32后台系统 - Web测试页面</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            color: #007bff;
            margin-top: 0;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.danger:hover {
            background: #c82333;
        }
        .button.success {
            background: #28a745;
        }
        .button.success:hover {
            background: #218838;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .data-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .data-item {
            padding: 5px;
            border-bottom: 1px solid #dee2e6;
        }
        .data-item:last-child {
            border-bottom: none;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: inline-block;
            width: 100px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ESP32后台系统 - Web测试页面</h1>
        
        <!-- 系统状态 -->
        <div class="section">
            <h3>系统状态</h3>
            <button class="button" onclick="getSystemStatus()">获取系统状态</button>
            <button class="button" onclick="getMQTTStatus()">获取MQTT状态</button>
            <div id="systemStatus"></div>
        </div>
        
        <!-- AD1数据 -->
        <div class="section">
            <h3>AD1数据采集</h3>
            <div class="form-group">
                <label>数据条数:</label>
                <input type="number" id="ad1Limit" value="50" min="1" max="1000">
            </div>
            <button class="button" onclick="getAD1Data()">获取AD1数据</button>
            <button class="button" onclick="getAD1Data(100)">获取最新100条</button>
            <div id="ad1Data"></div>
        </div>
        
        <!-- IO1控制 -->
        <div class="section">
            <h3>IO1开关控制</h3>
            <button class="button" onclick="getCurrentIO1State()">获取当前状态</button>
            <button class="button" onclick="getIO1History()">获取控制历史</button>
            <div class="form-group">
                <label>控制状态:</label>
                <select id="io1State">
                    <option value="true">开启 (True)</option>
                    <option value="false">关闭 (False)</option>
                </select>
            </div>
            <button class="button success" onclick="setIO1Control(true)">开启IO1</button>
            <button class="button danger" onclick="setIO1Control(false)">关闭IO1</button>
            <div id="io1Control"></div>
        </div>
        
        <!-- 设备状态 -->
        <div class="section">
            <h3>设备状态</h3>
            <div class="form-group">
                <label>状态条数:</label>
                <input type="number" id="statusLimit" value="20" min="1" max="100">
            </div>
            <button class="button" onclick="getDeviceStatus()">获取设备状态历史</button>
            <div id="deviceStatus"></div>
        </div>
        
        <!-- API测试 -->
        <div class="section">
            <h3>API接口测试</h3>
            <button class="button" onclick="testAPI()">测试API接口</button>
            <div id="apiTest"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        
        // 页面加载完成后自动获取IO1状态
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟1秒后自动获取状态，确保后端服务已启动
            setTimeout(() => {
                getCurrentIO1State();
            }, 1000);
        });
        
        // 显示状态信息
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        // 显示数据
        function showData(elementId, data, title = '') {
            const element = document.getElementById(elementId);
            if (title) {
                element.innerHTML = `<h4>${title}</h4>`;
            }
            
            if (Array.isArray(data)) {
                const dataHtml = data.map(item => {
                    if (typeof item === 'object') {
                        return `<div class="data-item">${JSON.stringify(item, null, 2)}</div>`;
                    } else {
                        return `<div class="data-item">${item}</div>`;
                    }
                }).join('');
                element.innerHTML += `<div class="data-display">${dataHtml}</div>`;
            } else {
                element.innerHTML += `<div class="data-display">${JSON.stringify(data, null, 2)}</div>`;
            }
        }
        
        // 获取系统状态
        async function getSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const result = await response.json();
                
                if (result.success) {
                    showData('systemStatus', result.data, '系统状态');
                } else {
                    showStatus('systemStatus', `获取失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('systemStatus', `请求错误: ${error.message}`, 'error');
            }
        }
        
        // 获取MQTT状态
        async function getMQTTStatus() {
            try {
                const response = await fetch(`${API_BASE}/mqtt/status`);
                const result = await response.json();
                
                if (result.success) {
                    const status = result.data.connected ? '已连接' : '未连接';
                    showStatus('systemStatus', `MQTT状态: ${status}`, result.data.connected ? 'success' : 'error');
                } else {
                    showStatus('systemStatus', `获取MQTT状态失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('systemStatus', `请求错误: ${error.message}`, 'error');
            }
        }
        
        // 获取AD1数据
        async function getAD1Data(limit) {
            try {
                const dataLimit = limit || document.getElementById('ad1Limit').value;
                const response = await fetch(`${API_BASE}/ad1/data?limit=${dataLimit}`);
                const result = await response.json();
                
                if (result.success) {
                    showData('ad1Data', result.data, `AD1数据 (共${result.data.length}条)`);
                } else {
                    showStatus('ad1Data', `获取AD1数据失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('ad1Data', `请求错误: ${error.message}`, 'error');
            }
        }
        
        // 获取当前IO1状态
        async function getCurrentIO1State() {
            try {
                const response = await fetch(`${API_BASE}/io1/current`);
                const result = await response.json();
                
                if (result.success) {
                    const state = result.data.state ? '开启' : '关闭';
                    showStatus('io1Control', `当前IO1状态: ${state}`, result.data.state ? 'success' : 'info');
                    
                    // 同步更新控制状态下拉框
                    updateIO1StateDropdown(result.data.state);
                } else {
                    showStatus('io1Control', `获取IO1状态失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('io1Control', `请求错误: ${error.message}`, 'error');
            }
        }
        
        // 更新IO1状态下拉框
        function updateIO1StateDropdown(state) {
            const dropdown = document.getElementById('io1State');
            dropdown.value = state.toString();
        }
        
        // 获取IO1控制历史
        async function getIO1History() {
            try {
                const response = await fetch(`${API_BASE}/io1/control`);
                const result = await response.json();
                
                if (result.success) {
                    showData('io1Control', result.data, `IO1控制历史 (共${result.data.length}条)`);
                } else {
                    showStatus('io1Control', `获取IO1控制历史失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('io1Control', `请求错误: ${error.message}`, 'error');
            }
        }
        
        // 设置IO1控制
        async function setIO1Control(state) {
            try {
                const response = await fetch(`${API_BASE}/io1/control`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ state: state })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('io1Control', `IO1控制命令已发送: ${state ? '开启' : '关闭'}`, 'success');
                    
                    // 延迟1秒后自动获取最新状态，确保命令已执行
                    setTimeout(() => {
                        getCurrentIO1State();
                    }, 1000);
                } else {
                    showStatus('io1Control', `设置IO1控制失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('io1Control', `请求错误: ${error.message}`, 'error');
            }
        }
        
        // 获取设备状态
        async function getDeviceStatus() {
            try {
                const limit = document.getElementById('statusLimit').value;
                const response = await fetch(`${API_BASE}/device/status?limit=${limit}`);
                const result = await response.json();
                
                if (result.success) {
                    showData('deviceStatus', result.data, `设备状态历史 (共${result.data.length}条)`);
                } else {
                    showStatus('deviceStatus', `获取设备状态失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('deviceStatus', `请求错误: ${error.message}`, 'error');
            }
        }
        
        // 测试API接口
        async function testAPI() {
            try {
                const response = await fetch(`${API_BASE}/test`);
                const result = await response.json();
                
                if (result.success) {
                    showStatus('apiTest', result.message, 'success');
                } else {
                    showStatus('apiTest', `API测试失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('apiTest', `请求错误: ${error.message}`, 'error');
            }
        }
        
        // 页面加载完成后自动获取系统状态
        window.onload = function() {
            getSystemStatus();
            // 延迟获取IO1状态，确保后端服务已启动
            setTimeout(() => {
                getCurrentIO1State();
            }, 2000);
        };
    </script>
</body>
</html>
