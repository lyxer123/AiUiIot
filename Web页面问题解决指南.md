# Web页面问题解决指南

## 问题描述
访问 `file:///E:/github/AiUiIot/web_test.html` 页面时，执行获取系统状态等功能出现错误：
```
请求错误: failed to fetch
```

## 问题原因
这个错误的主要原因是：
1. **文件协议限制**: `file://` 协议不允许进行网络请求
2. **CORS策略**: 浏览器的跨域安全策略阻止了请求
3. **服务器未启动**: Python后端服务未运行

## 解决方案

### 方案1: 通过HTTP服务器访问（推荐）

#### 步骤1: 启动Python后端服务
```bash
# 运行启动脚本
start_system_local.bat

# 或者手动启动
python main.py
```

#### 步骤2: 通过HTTP访问页面
在浏览器中访问：
```
http://10.1.95.252:5000/web_test.html
```

**注意**: 不要使用 `file://` 协议，必须使用 `http://` 协议

### 方案2: 使用改进版测试页面

我已经创建了一个改进版的测试页面 `web_test_improved.html`，它包含：
- 可配置的服务器地址和端口
- 更好的错误处理和提示
- 自动刷新功能
- 连接测试功能

#### 使用方法：
1. 将 `web_test_improved.html` 放在Web服务器目录中
2. 通过HTTP协议访问：`http://10.1.95.252:5000/web_test_improved.html`

### 方案3: 创建本地Web服务器

如果您想直接访问HTML文件，可以创建一个简单的本地Web服务器：

#### 使用Python创建本地服务器：
```bash
# 在项目根目录运行
cd E:\github\AiUiIot
python -m http.server 8080
```

然后在浏览器中访问：
```
http://localhost:8080/web_test.html
```

## 详细解决步骤

### 1. 检查服务状态
```bash
# 检查端口5000是否被监听
netstat -an | findstr ":5000"

# 检查端口1883是否被监听
netstat -an | findstr ":1883"
```

### 2. 启动MQTT服务器
```bash
# 运行简化版启动脚本
start_mqtt_simple.bat

# 或者手动启动
mosquitto -p 1883 -v
```

### 3. 启动Python后端
```bash
# 运行启动脚本
start_system_local.bat

# 或者手动启动
python main.py
```

### 4. 测试连接
在浏览器中访问：
```
http://10.1.95.252:5000/api/test
```

应该看到类似这样的响应：
```json
{
    "success": true,
    "message": "ESP32后台系统API运行正常"
}
```

### 5. 访问Web测试页面
```
http://10.1.95.252:5000/web_test.html
```

## 常见问题排查

### Q1: 仍然出现"failed to fetch"错误
**可能原因**:
- 服务器未启动
- 端口被占用
- 防火墙阻止连接

**解决方法**:
1. 检查Python后端是否正常运行
2. 确认端口5000未被其他服务占用
3. 检查Windows防火墙设置

### Q2: 页面可以访问但API调用失败
**可能原因**:
- CORS配置问题
- API路由未正确配置

**解决方法**:
1. 检查 `web_server.py` 中的CORS设置
2. 确认API路由已正确注册

### Q3: MQTT连接失败
**可能原因**:
- Mosquitto服务器未启动
- 端口1883被占用

**解决方法**:
1. 运行 `start_mqtt_simple.bat`
2. 检查端口占用情况

## 测试流程

### 完整测试流程：
1. **启动MQTT服务器** → 确认端口1883被监听
2. **启动Python后端** → 确认端口5000被监听
3. **测试API连接** → 访问 `http://10.1.95.252:5000/api/test`
4. **访问Web页面** → 使用HTTP协议访问测试页面
5. **测试功能** → 点击各种按钮测试系统功能

### 预期结果：
- 系统状态显示正常
- MQTT连接状态为"已连接"
- 可以获取AD1数据
- 可以控制IO1开关
- 数据实时更新

## 注意事项

1. **始终使用HTTP协议**: 不要使用 `file://` 协议访问HTML文件
2. **检查服务状态**: 确保MQTT和Python后端服务都在运行
3. **网络配置**: 确保防火墙允许端口5000和1883的访问
4. **错误日志**: 查看控制台输出和日志文件获取详细错误信息

## 联系支持

如果问题仍然存在，请：
1. 检查所有服务的运行状态
2. 查看错误日志和控制台输出
3. 确认网络配置和防火墙设置
4. 提供详细的错误信息和系统状态
