<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32åå°ç³»ç»Ÿ - Webæµ‹è¯•é¡µé¢ (æ”¹è¿›ç‰ˆ)</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            color: #007bff;
            margin-top: 0;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.danger:hover {
            background: #c82333;
        }
        .button.success {
            background: #28a745;
        }
        .button.success:hover {
            background: #218838;
        }
        .button.warning {
            background: #ffc107;
            color: #212529;
        }
        .button.warning:hover {
            background: #e0a800;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .data-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        .data-item {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
            font-family: monospace;
            font-size: 12px;
        }
        .data-item:last-child {
            border-bottom: none;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 200px;
        }
        .config-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }
        .connection-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .connection-status.connected {
            background: #28a745;
        }
        .connection-status.disconnected {
            background: #dc3545;
        }
        .connection-status.unknown {
            background: #ffc107;
        }
        .auto-refresh {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .timestamp {
            color: #6c757d;
            font-size: 12px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ESP32åå°ç³»ç»Ÿ - Webæµ‹è¯•é¡µé¢ (æ”¹è¿›ç‰ˆ)</h1>
        
        <!-- é…ç½®è®¾ç½® -->
        <div class="config-section">
            <h3>ğŸ”§ ç³»ç»Ÿé…ç½®</h3>
            <div class="form-group">
                <label>æœåŠ¡å™¨åœ°å€:</label>
                <input type="text" id="serverAddress" value="10.1.95.252" placeholder="è¾“å…¥æœåŠ¡å™¨IPåœ°å€">
            </div>
            <div class="form-group">
                <label>ç«¯å£å·:</label>
                <input type="number" id="serverPort" value="8080" min="1" max="65535">
            </div>
            <button class="button warning" onclick="updateAPIConfig()">æ›´æ–°é…ç½®</button>
            <button class="button" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
            <div id="configStatus"></div>
        </div>
        
        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="section">
            <h3>ğŸ“¡ è¿æ¥çŠ¶æ€</h3>
            <div class="auto-refresh">
                <label><input type="checkbox" id="autoRefresh" checked> è‡ªåŠ¨åˆ·æ–°çŠ¶æ€ (æ¯5ç§’)</label>
                <span class="timestamp">æœ€åæ›´æ–°: <span id="lastUpdate">-</span></span>
            </div>
            <button class="button" onclick="getSystemStatus()">è·å–ç³»ç»ŸçŠ¶æ€</button>
            <button class="button" onclick="getMQTTStatus()">è·å–MQTTçŠ¶æ€</button>
            <div id="systemStatus"></div>
        </div>
        
        <!-- AD1æ•°æ® -->
        <div class="section">
            <h3>ğŸ“Š AD1æ•°æ®é‡‡é›†</h3>
            <div class="form-group">
                <label>æ•°æ®æ¡æ•°:</label>
                <input type="number" id="ad1Limit" value="50" min="1" max="1000">
            </div>
            <button class="button" onclick="getAD1Data()">è·å–AD1æ•°æ®</button>
            <button class="button" onclick="getAD1Data(100)">è·å–æœ€æ–°100æ¡</button>
            <div id="ad1Data"></div>
        </div>
        
        <!-- IO1æ§åˆ¶ -->
        <div class="section">
            <h3>ğŸ›ï¸ IO1å¼€å…³æ§åˆ¶</h3>
            <button class="button" onclick="getCurrentIO1State()">è·å–å½“å‰çŠ¶æ€</button>
            <button class="button" onclick="getIO1History()">è·å–æ§åˆ¶å†å²</button>
            <div class="form-group">
                <label>æ§åˆ¶çŠ¶æ€:</label>
                <select id="io1State">
                    <option value="true">å¼€å¯ (True)</option>
                    <option value="false">å…³é—­ (False)</option>
                </select>
            </div>
            <button class="button success" onclick="setIO1Control(true)">å¼€å¯IO1</button>
            <button class="button danger" onclick="setIO1Control(false)">å…³é—­IO1</button>
            <div id="io1Control"></div>
        </div>
        
        <!-- è®¾å¤‡çŠ¶æ€ -->
        <div class="section">
            <h3>ğŸ“± è®¾å¤‡çŠ¶æ€</h3>
            <div class="form-group">
                <label>çŠ¶æ€æ¡æ•°:</label>
                <input type="number" id="statusLimit" value="20" min="1" max="100">
            </div>
            <button class="button" onclick="getDeviceStatus()">è·å–è®¾å¤‡çŠ¶æ€å†å²</button>
            <div id="deviceStatus"></div>
        </div>
        
        <!-- APIæµ‹è¯• -->
        <div class="section">
            <h3>ğŸ§ª APIæ¥å£æµ‹è¯•</h3>
            <button class="button" onclick="testAPI()">æµ‹è¯•APIæ¥å£</button>
            <button class="button warning" onclick="testMQTTAPI()">æµ‹è¯•MQTT API</button>
            <div id="apiTest"></div>
        </div>
    </div>

    <script>
        // åŸºäºæœ€ç»ˆæµ‹è¯•ç‰ˆçš„å¯é é…ç½®
        const API_BASE = 'http://localhost:8080/api';
        console.log('APIåŸºç¡€åœ°å€:', API_BASE);
        
        // åˆå§‹åŒ–é¡µé¢æ—¶è®¾ç½®é»˜è®¤å€¼
        function initializePage() {
            document.getElementById('serverAddress').value = 'localhost';
            document.getElementById('serverPort').value = '8080';
            testConnection(); // è‡ªåŠ¨æµ‹è¯•è¿æ¥
        }
        
        document.addEventListener('DOMContentLoaded', initializePage);
            
        console.log('å½“å‰APIåŸºç¡€åœ°å€:', API_BASE);
        let autoRefreshInterval = null;
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });
        
        // åˆå§‹åŒ–é¡µé¢
        function checkServerStatus() {
            return fetch(`${API_BASE}/test`, { method: 'GET' })
                .then(response => response.ok)
                .catch(() => false);
        }

        async function initializePage() {
            // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
            const isServerRunning = await checkServerStatus();
            if (!isServerRunning) {
                showStatus('configStatus', 
                    'âš ï¸ æœåŠ¡å™¨æœªè¿è¡Œï¼è¯·å…ˆå¯åŠ¨æœåŠ¡å™¨è„šæœ¬ (python web_server.py)', 
                    'error');
            }
            
            // ä»localStorageåŠ è½½é…ç½®
            loadConfig();
            
            // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
            setupAutoRefresh();
            
            // å»¶è¿Ÿè·å–åˆå§‹çŠ¶æ€
            setTimeout(() => {
                getSystemStatus();
                getCurrentIO1State();
            }, 1000);
        }
        
        // åŠ è½½é…ç½®
        function loadConfig() {
            const savedAddress = localStorage.getItem('serverAddress');
            const savedPort = localStorage.getItem('serverPort');
            
            if (savedAddress) document.getElementById('serverAddress').value = savedAddress;
            if (savedPort) document.getElementById('serverPort').value = savedPort;
            
            updateAPIConfig();
        }
        
        // æ›´æ–°APIé…ç½®
        function updateAPIConfig() {
            const address = document.getElementById('serverAddress').value.trim();
            const port = document.getElementById('serverPort').value.trim();
            
            if (address && port) {
                API_BASE = `http://${address}:${port}/api`;
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('serverAddress', address);
                localStorage.setItem('serverPort', port);
                
                showStatus('configStatus', `APIåœ°å€å·²æ›´æ–°: ${API_BASE}`, 'success');
                
                // æµ‹è¯•è¿æ¥
                setTimeout(() => testConnection(), 500);
            } else {
                showStatus('configStatus', 'è¯·è¾“å…¥æœ‰æ•ˆçš„æœåŠ¡å™¨åœ°å€å’Œç«¯å£', 'error');
            }
        }
        
        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            try {
                showStatus('configStatus', 'æ­£åœ¨è¿æ¥æœåŠ¡å™¨...', 'info');
                
                // ä½¿ç”¨æœ€ç»ˆéªŒè¯å¯é çš„ç®€å•è¯·æ±‚
                const response = await fetch(`${API_BASE}/test`);
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showStatus('configStatus', `è¿æ¥æˆåŠŸ! ${result.message}`, 'success');
                    } else {
                        showStatus('configStatus', `è¿æ¥å¤±è´¥: ${result.error}`, 'error');
                    }
                } else {
                    showStatus('configStatus', `HTTPé”™è¯¯: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                console.error('APIè¯·æ±‚é”™è¯¯:', error);
                let errorMsg = `è¿æ¥å¤±è´¥: ${error.message}<br>`;
                errorMsg += `å·²å°è¯•è®¿é—®: ${API_BASE}/test<br>`;
                errorMsg += 'âœ… ç®€åŒ–æµ‹è¯•å·²ç¡®è®¤æœåŠ¡å™¨æ­£å¸¸è¿è¡Œ<br>';
                errorMsg += 'ğŸ”§ å»ºè®®: ä½¿ç”¨Chromeæµè§ˆå™¨ï¼ŒæŒ‰F12æŸ¥çœ‹Consoleè·å–æ›´å¤šä¿¡æ¯';
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMsg = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ï¼š1) æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨ 2) åœ°å€å’Œç«¯å£æ˜¯å¦æ­£ç¡® 3) é˜²ç«å¢™è®¾ç½®';
                } else if (error.name === 'AbortError') {
                    errorMsg = 'è¿æ¥è¶…æ—¶';
                } else {
                    errorMsg = error.message;
                }
                showStatus('configStatus', errorMsg, 'error');
            }
        }
        
        // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
        function setupAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
            
            if (checkbox.checked) {
                startAutoRefresh();
            }
        }
        
        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(() => {
                getSystemStatus();
                getMQTTStatus(); // æ·»åŠ MQTTçŠ¶æ€åˆ·æ–°
                getCurrentIO1State();
                updateTimestamp();
            }, 5000);
        }
        
        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // æ›´æ–°æ—¶é—´æˆ³
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }
        
        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        // æ˜¾ç¤ºæ•°æ®
        function showData(elementId, data, title = '') {
            const element = document.getElementById(elementId);
            if (title) {
                element.innerHTML = `<h4>${title}</h4>`;
            }
            
            if (Array.isArray(data)) {
                if (data.length === 0) {
                    element.innerHTML += `<div class="status info">æš‚æ— æ•°æ®</div>`;
                    return;
                }
                
                const dataHtml = data.map(item => {
                    if (typeof item === 'object') {
                        return `<div class="data-item">${JSON.stringify(item, null, 2)}</div>`;
                    } else {
                        return `<div class="data-item">${item}</div>`;
                    }
                }).join('');
                element.innerHTML += `<div class="data-display">${dataHtml}</div>`;
            } else {
                element.innerHTML += `<div class="data-display">${JSON.stringify(data, null, 2)}</div>`;
            }
        }
        
        // è·å–ç³»ç»ŸçŠ¶æ€
        async function getSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const result = await response.json();
                
                if (result.success) {
                    const status = result.data;
                    console.log('ç³»ç»ŸçŠ¶æ€APIå“åº”:', status);
                    console.log('MQTTè¿æ¥çŠ¶æ€:', status.mqtt_connected);
                    
                    const html = `
                        <div class="status success">
                            <div><strong>ç³»ç»ŸçŠ¶æ€:</strong> ${status.system_status}</div>
                            <div><strong>MQTTè¿æ¥:</strong> <span class="connection-status ${status.mqtt_connected ? 'connected' : 'disconnected'}"></span>${status.mqtt_connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}</div>
                            <div><strong>IO1å½“å‰çŠ¶æ€:</strong> ${status.io1_current_state ? 'å¼€å¯' : 'å…³é—­'}</div>
                        </div>
                    `;
                    document.getElementById('systemStatus').innerHTML = html;
                    
                    // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
                    const now = new Date();
                    document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
                    
                    // å¦‚æœMQTTçŠ¶æ€ä¸ºtrueï¼Œæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    if (status.mqtt_connected) {
                        console.log('âœ… MQTTçŠ¶æ€æ˜¾ç¤ºä¸ºå·²è¿æ¥');
                    } else {
                        console.log('âŒ MQTTçŠ¶æ€æ˜¾ç¤ºä¸ºæœªè¿æ¥');
                    }
                } else {
                    console.error('ç³»ç»ŸçŠ¶æ€APIå¤±è´¥:', result.error);
                    showStatus('systemStatus', `è·å–å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('è·å–ç³»ç»ŸçŠ¶æ€é”™è¯¯:', error);
                showStatus('systemStatus', `è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // è·å–MQTTçŠ¶æ€
        async function getMQTTStatus() {
            try {
                const response = await fetch(`${API_BASE}/mqtt/status`);
                const result = await response.json();
                
                if (result.success) {
                    const isConnected = result.data.connected;
                    const status = isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
                    const type = isConnected ? 'success' : 'error';
                    
                    console.log(`MQTTçŠ¶æ€æ›´æ–°: ${status} (APIè¿”å›: ${isConnected})`);
                    console.log('MQTTçŠ¶æ€APIå®Œæ•´å“åº”:', result);
                    
                    // å¼ºåˆ¶åˆ·æ–°ç³»ç»ŸçŠ¶æ€æ˜¾ç¤º
                    await getSystemStatus();
                    
                    // å¦‚æœç³»ç»ŸçŠ¶æ€ä¸­æ²¡æœ‰MQTTä¿¡æ¯ï¼Œå•ç‹¬æ˜¾ç¤ºMQTTçŠ¶æ€
                    const systemStatusElement = document.getElementById('systemStatus');
                    if (!systemStatusElement.innerHTML.includes('MQTTè¿æ¥:')) {
                        showStatus('systemStatus', `MQTTçŠ¶æ€: ${status}`, type);
                    }
                    
                } else {
                    console.error('MQTTçŠ¶æ€APIå¤±è´¥:', result.error);
                    showStatus('systemStatus', `è·å–MQTTçŠ¶æ€å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('è·å–MQTTçŠ¶æ€é”™è¯¯:', error);
                showStatus('systemStatus', `è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // è·å–AD1æ•°æ®
        async function getAD1Data(limit) {
            try {
                const dataLimit = limit || document.getElementById('ad1Limit').value;
                const response = await fetch(`${API_BASE}/ad1/data?limit=${dataLimit}`);
                const result = await response.json();
                
                if (result.success) {
                    showData('ad1Data', result.data, `AD1æ•°æ® (å…±${result.data.length}æ¡)`);
                } else {
                    showStatus('ad1Data', `è·å–AD1æ•°æ®å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('ad1Data', `è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // è·å–å½“å‰IO1çŠ¶æ€
        async function getCurrentIO1State() {
            try {
                const response = await fetch(`${API_BASE}/io1/current`);
                const result = await response.json();
                
                if (result.success) {
                    const state = result.data.state ? 'å¼€å¯' : 'å…³é—­';
                    const type = result.data.state ? 'success' : 'info';
                    showStatus('io1Control', `å½“å‰IO1çŠ¶æ€: ${state}`, type);
                    
                    // åŒæ­¥æ›´æ–°æ§åˆ¶çŠ¶æ€ä¸‹æ‹‰æ¡†
                    updateIO1StateDropdown(result.data.state);
                } else {
                    showStatus('io1Control', `è·å–IO1çŠ¶æ€å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('io1Control', `è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // æ›´æ–°IO1çŠ¶æ€ä¸‹æ‹‰æ¡†
        function updateIO1StateDropdown(state) {
            const dropdown = document.getElementById('io1State');
            dropdown.value = state.toString();
        }
        
        // è·å–IO1æ§åˆ¶å†å²
        async function getIO1History() {
            try {
                const response = await fetch(`${API_BASE}/io1/control`);
                const result = await response.json();
                
                if (result.success) {
                    showData('io1Control', result.data, `IO1æ§åˆ¶å†å² (å…±${result.data.length}æ¡)`);
                } else {
                    showStatus('io1Control', `è·å–IO1æ§åˆ¶å†å²å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('io1Control', `è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // è®¾ç½®IO1æ§åˆ¶
        async function setIO1Control(state) {
            try {
                showStatus('io1Control', 'æ­£åœ¨å‘é€æ§åˆ¶å‘½ä»¤...', 'info');
                
                const response = await fetch(`${API_BASE}/io1/control`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ state: state })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('io1Control', `IO1æ§åˆ¶å‘½ä»¤å·²å‘é€: ${state ? 'å¼€å¯' : 'å…³é—­'}`, 'success');
                    
                    // å»¶è¿Ÿ1ç§’åè‡ªåŠ¨è·å–æœ€æ–°çŠ¶æ€ï¼Œç¡®ä¿å‘½ä»¤å·²æ‰§è¡Œ
                    setTimeout(() => {
                        getCurrentIO1State();
                    }, 1000);
                } else {
                    showStatus('io1Control', `è®¾ç½®IO1æ§åˆ¶å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('io1Control', `è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // è·å–è®¾å¤‡çŠ¶æ€
        async function getDeviceStatus() {
            try {
                const limit = document.getElementById('statusLimit').value;
                const response = await fetch(`${API_BASE}/device/status?limit=${limit}`);
                const result = await response.json();
                
                if (result.success) {
                    showData('deviceStatus', result.data, `è®¾å¤‡çŠ¶æ€å†å² (å…±${result.data.length}æ¡)`);
                } else {
                    showStatus('deviceStatus', `è·å–è®¾å¤‡çŠ¶æ€å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('deviceStatus', `è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // æµ‹è¯•APIæ¥å£
        async function testAPI() {
            try {
                const response = await fetch(`${API_BASE}/test`);
                const result = await response.json();
                
                if (result.success) {
                    showStatus('apiTest', result.message, 'success');
                } else {
                    showStatus('apiTest', `APIæµ‹è¯•å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('apiTest', `è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // æµ‹è¯•MQTTçŠ¶æ€API
        async function testMQTTAPI() {
            try {
                console.log('ğŸ§ª å¼€å§‹æµ‹è¯•MQTTçŠ¶æ€API...');
                
                // æµ‹è¯•MQTTçŠ¶æ€API
                const mqttResponse = await fetch(`${API_BASE}/mqtt/status`);
                const mqttResult = await mqttResponse.json();
                console.log('MQTTçŠ¶æ€APIå“åº”:', mqttResult);
                
                // æµ‹è¯•ç³»ç»ŸçŠ¶æ€API
                const statusResponse = await fetch(`${API_BASE}/status`);
                const statusResult = await statusResponse.json();
                console.log('ç³»ç»ŸçŠ¶æ€APIå“åº”:', statusResult);
                
                // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
                let testResult = '<div class="status info"><h4>MQTT APIæµ‹è¯•ç»“æœ</h4>';
                testResult += `<div>MQTTçŠ¶æ€API: ${mqttResult.success ? 'æˆåŠŸ' : 'å¤±è´¥'}</div>`;
                if (mqttResult.success) {
                    testResult += `<div>MQTTè¿æ¥çŠ¶æ€: ${mqttResult.data.connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}</div>`;
                }
                testResult += `<div>ç³»ç»ŸçŠ¶æ€API: ${statusResult.success ? 'æˆåŠŸ' : 'å¤±è´¥'}</div>`;
                if (statusResult.success) {
                    testResult += `<div>ç³»ç»ŸMQTTçŠ¶æ€: ${statusResult.data.mqtt_connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}</div>`;
                }
                testResult += '</div>';
                
                document.getElementById('apiTest').innerHTML = testResult;
                
            } catch (error) {
                console.error('MQTT APIæµ‹è¯•å¤±è´¥:', error);
                showStatus('apiTest', `MQTT APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });
    </script>
</body>
</html>
