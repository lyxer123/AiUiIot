<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32后台系统 - Web测试页面 (改进版)</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            color: #007bff;
            margin-top: 0;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.danger:hover {
            background: #c82333;
        }
        .button.success {
            background: #28a745;
        }
        .button.success:hover {
            background: #218838;
        }
        .button.warning {
            background: #ffc107;
            color: #212529;
        }
        .button.warning:hover {
            background: #e0a800;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .data-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        .data-item {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
            font-family: monospace;
            font-size: 12px;
        }
        .data-item:last-child {
            border-bottom: none;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 200px;
        }
        .config-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }
        .connection-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .connection-status.connected {
            background: #28a745;
        }
        .connection-status.disconnected {
            background: #dc3545;
        }
        .connection-status.unknown {
            background: #ffc107;
        }
        .auto-refresh {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .timestamp {
            color: #6c757d;
            font-size: 12px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ESP32后台系统 - Web测试页面 (改进版)</h1>
        
        <!-- 配置设置 -->
        <div class="config-section">
            <h3>🔧 系统配置</h3>
            <div class="form-group">
                <label>服务器地址:</label>
                <input type="text" id="serverAddress" value="10.1.95.252" placeholder="输入服务器IP地址">
            </div>
            <div class="form-group">
                <label>端口号:</label>
                <input type="number" id="serverPort" value="8080" min="1" max="65535">
            </div>
            <button class="button warning" onclick="updateAPIConfig()">更新配置</button>
            <button class="button" onclick="testConnection()">测试连接</button>
            <div id="configStatus"></div>
        </div>
        
        <!-- 连接状态 -->
        <div class="section">
            <h3>📡 连接状态</h3>
            <div class="auto-refresh">
                <label><input type="checkbox" id="autoRefresh" checked> 自动刷新状态 (每5秒)</label>
                <span class="timestamp">最后更新: <span id="lastUpdate">-</span></span>
            </div>
            <button class="button" onclick="getSystemStatus()">获取系统状态</button>
            <button class="button" onclick="getMQTTStatus()">获取MQTT状态</button>
            <div id="systemStatus"></div>
        </div>
        
        <!-- AD1数据 -->
        <div class="section">
            <h3>📊 AD1数据采集</h3>
            <div class="form-group">
                <label>数据条数:</label>
                <input type="number" id="ad1Limit" value="50" min="1" max="1000">
            </div>
            <button class="button" onclick="getAD1Data()">获取AD1数据</button>
            <button class="button" onclick="getAD1Data(100)">获取最新100条</button>
            <div id="ad1Data"></div>
        </div>
        
        <!-- IO1控制 -->
        <div class="section">
            <h3>🎛️ IO1开关控制</h3>
            <button class="button" onclick="getCurrentIO1State()">获取当前状态</button>
            <button class="button" onclick="getIO1History()">获取控制历史</button>
            <div class="form-group">
                <label>控制状态:</label>
                <select id="io1State">
                    <option value="true">开启 (True)</option>
                    <option value="false">关闭 (False)</option>
                </select>
            </div>
            <button class="button success" onclick="setIO1Control(true)">开启IO1</button>
            <button class="button danger" onclick="setIO1Control(false)">关闭IO1</button>
            <div id="io1Control"></div>
        </div>
        
        <!-- 设备状态 -->
        <div class="section">
            <h3>📱 设备状态</h3>
            <div class="form-group">
                <label>状态条数:</label>
                <input type="number" id="statusLimit" value="20" min="1" max="100">
            </div>
            <button class="button" onclick="getDeviceStatus()">获取设备状态历史</button>
            <div id="deviceStatus"></div>
        </div>
        
        <!-- API测试 -->
        <div class="section">
            <h3>🧪 API接口测试</h3>
            <button class="button" onclick="testAPI()">测试API接口</button>
            <button class="button warning" onclick="testMQTTAPI()">测试MQTT API</button>
            <div id="apiTest"></div>
        </div>
    </div>

    <script>
        // 基于最终测试版的可靠配置
        const API_BASE = 'http://localhost:8080/api';
        console.log('API基础地址:', API_BASE);
        
        // 初始化页面时设置默认值
        function initializePage() {
            document.getElementById('serverAddress').value = 'localhost';
            document.getElementById('serverPort').value = '8080';
            testConnection(); // 自动测试连接
        }
        
        document.addEventListener('DOMContentLoaded', initializePage);
            
        console.log('当前API基础地址:', API_BASE);
        let autoRefreshInterval = null;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });
        
        // 初始化页面
        function checkServerStatus() {
            return fetch(`${API_BASE}/test`, { method: 'GET' })
                .then(response => response.ok)
                .catch(() => false);
        }

        async function initializePage() {
            // 检查服务器状态
            const isServerRunning = await checkServerStatus();
            if (!isServerRunning) {
                showStatus('configStatus', 
                    '⚠️ 服务器未运行！请先启动服务器脚本 (python web_server.py)', 
                    'error');
            }
            
            // 从localStorage加载配置
            loadConfig();
            
            // 设置自动刷新
            setupAutoRefresh();
            
            // 延迟获取初始状态
            setTimeout(() => {
                getSystemStatus();
                getCurrentIO1State();
            }, 1000);
        }
        
        // 加载配置
        function loadConfig() {
            const savedAddress = localStorage.getItem('serverAddress');
            const savedPort = localStorage.getItem('serverPort');
            
            if (savedAddress) document.getElementById('serverAddress').value = savedAddress;
            if (savedPort) document.getElementById('serverPort').value = savedPort;
            
            updateAPIConfig();
        }
        
        // 更新API配置
        function updateAPIConfig() {
            const address = document.getElementById('serverAddress').value.trim();
            const port = document.getElementById('serverPort').value.trim();
            
            if (address && port) {
                API_BASE = `http://${address}:${port}/api`;
                
                // 保存到localStorage
                localStorage.setItem('serverAddress', address);
                localStorage.setItem('serverPort', port);
                
                showStatus('configStatus', `API地址已更新: ${API_BASE}`, 'success');
                
                // 测试连接
                setTimeout(() => testConnection(), 500);
            } else {
                showStatus('configStatus', '请输入有效的服务器地址和端口', 'error');
            }
        }
        
        // 测试连接
        async function testConnection() {
            try {
                showStatus('configStatus', '正在连接服务器...', 'info');
                
                // 使用最终验证可靠的简单请求
                const response = await fetch(`${API_BASE}/test`);
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showStatus('configStatus', `连接成功! ${result.message}`, 'success');
                    } else {
                        showStatus('configStatus', `连接失败: ${result.error}`, 'error');
                    }
                } else {
                    showStatus('configStatus', `HTTP错误: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                console.error('API请求错误:', error);
                let errorMsg = `连接失败: ${error.message}<br>`;
                errorMsg += `已尝试访问: ${API_BASE}/test<br>`;
                errorMsg += '✅ 简化测试已确认服务器正常运行<br>';
                errorMsg += '🔧 建议: 使用Chrome浏览器，按F12查看Console获取更多信息';
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMsg = '无法连接到服务器，请检查：1) 服务器是否启动 2) 地址和端口是否正确 3) 防火墙设置';
                } else if (error.name === 'AbortError') {
                    errorMsg = '连接超时';
                } else {
                    errorMsg = error.message;
                }
                showStatus('configStatus', errorMsg, 'error');
            }
        }
        
        // 设置自动刷新
        function setupAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
            
            if (checkbox.checked) {
                startAutoRefresh();
            }
        }
        
        // 开始自动刷新
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(() => {
                getSystemStatus();
                getMQTTStatus(); // 添加MQTT状态刷新
                getCurrentIO1State();
                updateTimestamp();
            }, 5000);
        }
        
        // 停止自动刷新
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // 更新时间戳
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }
        
        // 显示状态信息
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        // 显示数据
        function showData(elementId, data, title = '') {
            const element = document.getElementById(elementId);
            if (title) {
                element.innerHTML = `<h4>${title}</h4>`;
            }
            
            if (Array.isArray(data)) {
                if (data.length === 0) {
                    element.innerHTML += `<div class="status info">暂无数据</div>`;
                    return;
                }
                
                const dataHtml = data.map(item => {
                    if (typeof item === 'object') {
                        return `<div class="data-item">${JSON.stringify(item, null, 2)}</div>`;
                    } else {
                        return `<div class="data-item">${item}</div>`;
                    }
                }).join('');
                element.innerHTML += `<div class="data-display">${dataHtml}</div>`;
            } else {
                element.innerHTML += `<div class="data-display">${JSON.stringify(data, null, 2)}</div>`;
            }
        }
        
        // 获取系统状态
        async function getSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const result = await response.json();
                
                if (result.success) {
                    const status = result.data;
                    console.log('系统状态API响应:', status);
                    console.log('MQTT连接状态:', status.mqtt_connected);
                    
                    const html = `
                        <div class="status success">
                            <div><strong>系统状态:</strong> ${status.system_status}</div>
                            <div><strong>MQTT连接:</strong> <span class="connection-status ${status.mqtt_connected ? 'connected' : 'disconnected'}"></span>${status.mqtt_connected ? '已连接' : '未连接'}</div>
                            <div><strong>IO1当前状态:</strong> ${status.io1_current_state ? '开启' : '关闭'}</div>
                        </div>
                    `;
                    document.getElementById('systemStatus').innerHTML = html;
                    
                    // 更新最后更新时间
                    const now = new Date();
                    document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
                    
                    // 如果MQTT状态为true，显示成功消息
                    if (status.mqtt_connected) {
                        console.log('✅ MQTT状态显示为已连接');
                    } else {
                        console.log('❌ MQTT状态显示为未连接');
                    }
                } else {
                    console.error('系统状态API失败:', result.error);
                    showStatus('systemStatus', `获取失败: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('获取系统状态错误:', error);
                showStatus('systemStatus', `请求错误: ${error.message}`, 'error');
            }
        }
        
        // 获取MQTT状态
        async function getMQTTStatus() {
            try {
                const response = await fetch(`${API_BASE}/mqtt/status`);
                const result = await response.json();
                
                if (result.success) {
                    const isConnected = result.data.connected;
                    const status = isConnected ? '已连接' : '未连接';
                    const type = isConnected ? 'success' : 'error';
                    
                    console.log(`MQTT状态更新: ${status} (API返回: ${isConnected})`);
                    console.log('MQTT状态API完整响应:', result);
                    
                    // 强制刷新系统状态显示
                    await getSystemStatus();
                    
                    // 如果系统状态中没有MQTT信息，单独显示MQTT状态
                    const systemStatusElement = document.getElementById('systemStatus');
                    if (!systemStatusElement.innerHTML.includes('MQTT连接:')) {
                        showStatus('systemStatus', `MQTT状态: ${status}`, type);
                    }
                    
                } else {
                    console.error('MQTT状态API失败:', result.error);
                    showStatus('systemStatus', `获取MQTT状态失败: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('获取MQTT状态错误:', error);
                showStatus('systemStatus', `请求错误: ${error.message}`, 'error');
            }
        }
        
        // 获取AD1数据
        async function getAD1Data(limit) {
            try {
                const dataLimit = limit || document.getElementById('ad1Limit').value;
                const response = await fetch(`${API_BASE}/ad1/data?limit=${dataLimit}`);
                const result = await response.json();
                
                if (result.success) {
                    showData('ad1Data', result.data, `AD1数据 (共${result.data.length}条)`);
                } else {
                    showStatus('ad1Data', `获取AD1数据失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('ad1Data', `请求错误: ${error.message}`, 'error');
            }
        }
        
        // 获取当前IO1状态
        async function getCurrentIO1State() {
            try {
                const response = await fetch(`${API_BASE}/io1/current`);
                const result = await response.json();
                
                if (result.success) {
                    const state = result.data.state ? '开启' : '关闭';
                    const type = result.data.state ? 'success' : 'info';
                    showStatus('io1Control', `当前IO1状态: ${state}`, type);
                    
                    // 同步更新控制状态下拉框
                    updateIO1StateDropdown(result.data.state);
                } else {
                    showStatus('io1Control', `获取IO1状态失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('io1Control', `请求错误: ${error.message}`, 'error');
            }
        }
        
        // 更新IO1状态下拉框
        function updateIO1StateDropdown(state) {
            const dropdown = document.getElementById('io1State');
            dropdown.value = state.toString();
        }
        
        // 获取IO1控制历史
        async function getIO1History() {
            try {
                const response = await fetch(`${API_BASE}/io1/control`);
                const result = await response.json();
                
                if (result.success) {
                    showData('io1Control', result.data, `IO1控制历史 (共${result.data.length}条)`);
                } else {
                    showStatus('io1Control', `获取IO1控制历史失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('io1Control', `请求错误: ${error.message}`, 'error');
            }
        }
        
        // 设置IO1控制
        async function setIO1Control(state) {
            try {
                showStatus('io1Control', '正在发送控制命令...', 'info');
                
                const response = await fetch(`${API_BASE}/io1/control`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ state: state })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('io1Control', `IO1控制命令已发送: ${state ? '开启' : '关闭'}`, 'success');
                    
                    // 延迟1秒后自动获取最新状态，确保命令已执行
                    setTimeout(() => {
                        getCurrentIO1State();
                    }, 1000);
                } else {
                    showStatus('io1Control', `设置IO1控制失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('io1Control', `请求错误: ${error.message}`, 'error');
            }
        }
        
        // 获取设备状态
        async function getDeviceStatus() {
            try {
                const limit = document.getElementById('statusLimit').value;
                const response = await fetch(`${API_BASE}/device/status?limit=${limit}`);
                const result = await response.json();
                
                if (result.success) {
                    showData('deviceStatus', result.data, `设备状态历史 (共${result.data.length}条)`);
                } else {
                    showStatus('deviceStatus', `获取设备状态失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('deviceStatus', `请求错误: ${error.message}`, 'error');
            }
        }
        
        // 测试API接口
        async function testAPI() {
            try {
                const response = await fetch(`${API_BASE}/test`);
                const result = await response.json();
                
                if (result.success) {
                    showStatus('apiTest', result.message, 'success');
                } else {
                    showStatus('apiTest', `API测试失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('apiTest', `请求错误: ${error.message}`, 'error');
            }
        }
        
        // 测试MQTT状态API
        async function testMQTTAPI() {
            try {
                console.log('🧪 开始测试MQTT状态API...');
                
                // 测试MQTT状态API
                const mqttResponse = await fetch(`${API_BASE}/mqtt/status`);
                const mqttResult = await mqttResponse.json();
                console.log('MQTT状态API响应:', mqttResult);
                
                // 测试系统状态API
                const statusResponse = await fetch(`${API_BASE}/status`);
                const statusResult = await statusResponse.json();
                console.log('系统状态API响应:', statusResult);
                
                // 显示测试结果
                let testResult = '<div class="status info"><h4>MQTT API测试结果</h4>';
                testResult += `<div>MQTT状态API: ${mqttResult.success ? '成功' : '失败'}</div>`;
                if (mqttResult.success) {
                    testResult += `<div>MQTT连接状态: ${mqttResult.data.connected ? '已连接' : '未连接'}</div>`;
                }
                testResult += `<div>系统状态API: ${statusResult.success ? '成功' : '失败'}</div>`;
                if (statusResult.success) {
                    testResult += `<div>系统MQTT状态: ${statusResult.data.mqtt_connected ? '已连接' : '未连接'}</div>`;
                }
                testResult += '</div>';
                
                document.getElementById('apiTest').innerHTML = testResult;
                
            } catch (error) {
                console.error('MQTT API测试失败:', error);
                showStatus('apiTest', `MQTT API测试失败: ${error.message}`, 'error');
            }
        }
        
        // 页面卸载时清理定时器
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });
    </script>
</body>
</html>
