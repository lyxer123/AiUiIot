<!--control.wxml-->
<view class="container">
  <!-- 页面标题 -->
  <view class="page-header">
    <view class="page-title">设备控制中心</view>
    <view class="page-subtitle">实时控制ESP32设备状态</view>
  </view>

  <!-- 连接状态卡片 -->
  <view class="card">
    <view class="card-title">连接状态</view>
    <view class="connection-status">
      <view class="status-item">
        <view class="status-icon {{mqttStatus ? 'online' : 'offline'}}"></view>
        <view class="status-info">
          <view class="status-label">MQTT连接</view>
          <view class="status-value">{{mqttStatus ? '已连接' : '未连接'}}</view>
        </view>
      </view>
      <view class="status-item">
        <view class="status-icon {{deviceStatus ? 'online' : 'offline'}}"></view>
        <view class="status-info">
          <view class="status-label">设备状态</view>
          <view class="status-value">{{deviceStatus || '未知'}}</view>
        </view>
      </view>
    </view>
    <view class="btn-group">
      <button class="btn btn-outline" bindtap="refreshConnectionStatus">刷新状态</button>
      <button class="btn btn-primary" bindtap="testConnection">测试连接</button>
    </view>
  </view>

  <!-- IO1控制卡片 -->
  <view class="card">
    <view class="card-title">IO1开关控制</view>
    
    <!-- 当前状态显示 -->
    <view class="current-status">
      <view class="status-display">
        <view class="status-circle {{io1CurrentState ? 'on' : 'off'}}">
          <view class="status-text">{{io1CurrentState ? 'ON' : 'OFF'}}</view>
        </view>
        <view class="status-info">
          <view class="status-title">当前状态</view>
          <view class="status-desc">{{io1CurrentState ? 'IO1已开启' : 'IO1已关闭'}}</view>
          <view class="status-time">最后更新: {{lastUpdateTime || '--'}}</view>
        </view>
      </view>
    </view>

    <!-- 控制按钮 -->
    <view class="control-buttons">
      <button class="control-btn control-btn-on {{io1CurrentState ? 'active' : ''}}" 
              bindtap="turnOnIO1" disabled="{{io1CurrentState}}">
        <view class="btn-icon">🔴</view>
        <view class="btn-text">开启IO1</view>
      </button>
      <button class="control-btn control-btn-off {{!io1CurrentState ? 'active' : ''}}" 
              bindtap="turnOffIO1" disabled="{{!io1CurrentState}}">
        <view class="btn-icon">⚫</view>
        <view class="btn-text">关闭IO1</view>
      </button>
    </view>

    <!-- 状态同步 -->
    <view class="sync-section">
      <button class="btn btn-outline" bindtap="refreshIO1Status">刷新状态</button>
      <button class="btn btn-secondary" bindtap="toggleAutoSync">
        {{autoSync ? '关闭自动同步' : '开启自动同步'}}
      </button>
    </view>
  </view>

  <!-- 控制历史卡片 -->
  <view class="card">
    <view class="card-title">控制历史</view>
    <view class="history-controls">
      <view class="history-filter">
        <text class="filter-label">显示条数:</text>
        <picker bindchange="onLimitChange" value="{{historyLimitIndex}}" range="{{historyLimitOptions}}">
          <view class="picker">{{historyLimitOptions[historyLimitIndex]}}</view>
        </picker>
      </view>
      <button class="btn btn-primary" bindtap="loadControlHistory">加载历史</button>
    </view>
    
    <!-- 历史记录列表 -->
    <view class="history-list" wx:if="{{controlHistory.length > 0}}">
      <view class="history-item" wx:for="{{controlHistory}}" wx:key="index">
        <view class="history-status">
          <view class="status-dot {{item.state ? 'on' : 'off'}}"></view>
          <text class="status-text">{{item.state ? '开启' : '关闭'}}</text>
        </view>
        <view class="history-time">{{formatHistoryTime(item.timestamp)}}</view>
      </view>
    </view>
    
    <!-- 空状态 -->
    <view class="empty-history" wx:if="{{controlHistory.length === 0 && !loadingHistory}}">
      <view class="empty-icon">📝</view>
      <text>暂无控制历史记录</text>
    </view>
  </view>

  <!-- 批量控制卡片 -->
  <view class="card">
    <view class="card-title">批量控制</view>
    <view class="batch-controls">
      <view class="control-sequence">
        <view class="sequence-item">
          <text class="sequence-label">序列1:</text>
          <button class="btn btn-sm {{sequence1 ? 'btn-success' : 'btn-outline'}}" 
                  bindtap="toggleSequence1">{{sequence1 ? '开启' : '关闭'}}</button>
        </view>
        <view class="sequence-item">
          <text class="sequence-label">序列2:</text>
          <button class="btn btn-sm {{sequence2 ? 'btn-success' : 'btn-outline'}}" 
                  bindtap="toggleSequence2">{{sequence2 ? '开启' : '关闭'}}</button>
        </view>
      </view>
      <view class="btn-group">
        <button class="btn btn-primary" bindtap="executeSequence">执行序列</button>
        <button class="btn btn-outline" bindtap="clearSequence">清除序列</button>
      </view>
    </view>
  </view>

  <!-- 设置卡片 -->
  <view class="card">
    <view class="card-title">控制设置</view>
    <view class="settings-list">
      <view class="setting-item">
        <text class="setting-label">自动刷新间隔</text>
        <picker bindchange="onRefreshIntervalChange" value="{{refreshIntervalIndex}}" range="{{refreshIntervalOptions}}">
          <view class="picker">{{refreshIntervalOptions[refreshIntervalIndex]}}</view>
        </picker>
      </view>
      <view class="setting-item">
        <text class="setting-label">确认对话框</text>
        <switch checked="{{confirmDialog}}" bindchange="onConfirmDialogChange" color="#007AFF" />
      </view>
      <view class="setting-item">
        <text class="setting-label">声音提示</text>
        <switch checked="{{soundAlert}}" bindchange="onSoundAlertChange" color="#007AFF" />
      </view>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading" wx:if="{{loading}}">
    <view class="loading-icon">⏳</view>
    <text>正在加载...</text>
  </view>

  <!-- 错误状态 -->
  <view class="error" wx:if="{{error}}">
    <view class="error-icon">⚠️</view>
    <text>{{error}}</text>
    <button class="btn btn-primary" bindtap="retry">重试</button>
  </view>
</view>
