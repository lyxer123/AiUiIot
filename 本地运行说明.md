# ESP32物联网控制系统 - 本地运行说明

## 系统概述
本项目是一个完整的ESP32物联网控制系统，包含：
- ESP32固件（Arduino框架）
- Python后端服务器
- MQTT通信协议
- Web控制界面
- 数据库存储

## 修改说明
已根据您的需求修改配置：
- 服务器IP: **10.1.95.252**
- MQTT端口: 1883
- Web服务端口: 5000

## 运行步骤

### 1. 安装依赖
确保您的计算机已安装：
- Python 3.7+
- Mosquitto MQTT服务器

### 2. 启动MQTT服务器
```bash
# 方法1: 使用提供的脚本
start_mqtt_server.bat

# 方法2: 手动启动
mosquitto -c ESP32IOT\src\mosquitto.conf -v
```

### 3. 启动Python后端系统
```bash
# 方法1: 使用提供的脚本
start_system_local.bat

# 方法2: 手动启动
python main.py
```

### 4. 访问Web界面
打开浏览器访问：http://10.1.95.252:5000

## 系统架构

### ESP32固件功能
- WiFi连接管理
- MQTT客户端通信
- AD1模拟量采集 (GPIO36)
- IO1数字输出控制 (GPIO2)
- 自动重连机制
- 状态LED指示

### Python后端功能
- MQTT消息处理
- 数据存储管理
- Web API服务
- ESP32模拟器（开发测试用）

### MQTT主题
- `esp32/ad1/data` - AD数据上传
- `esp32/io1/control` - IO控制命令
- `esp32/status` - 设备状态

## 配置说明

### ESP32配置 (ESP32IOT/src/config.h)
```c
#define MQTT_BROKER "10.1.95.252"  // MQTT服务器IP
#define MQTT_PORT 1883             // MQTT端口
#define WIFI_SSID "YourWiFiSSID"   // 修改为您的WiFi名称
#define WIFI_PASSWORD "YourWiFiPassword"  // 修改为您的WiFi密码
```

### Python后端配置 (config.ini)
```ini
[MQTT]
broker = 10.1.95.252
port = 1883

[WEB_SERVER]
host = 10.1.95.252
port = 5000
```

## 硬件连接

### ESP32引脚定义
- **AD1**: GPIO36 (VP) - 模拟输入
- **IO1**: GPIO2 - 数字输出
- **STATUS_LED**: GPIO2 - 状态指示灯（与IO1共用）

### 连接说明
1. 将模拟传感器连接到GPIO36
2. 将继电器或LED连接到GPIO2
3. 确保ESP32连接到WiFi网络

## 测试方法

### 1. 系统状态检查
访问API: `GET /api/status`

### 2. 获取AD数据
访问API: `GET /api/ad1/data`

### 3. 控制IO1
发送POST请求到: `POST /api/io1/control`
```json
{
    "state": true
}
```

### 4. 查看MQTT状态
访问API: `GET /api/mqtt/status`

## 故障排除

### 常见问题
1. **MQTT连接失败**
   - 检查Mosquitto服务器是否运行
   - 确认端口1883未被占用

2. **Web服务无法访问**
   - 检查防火墙设置
   - 确认端口5000未被占用

3. **ESP32无法连接**
   - 检查WiFi配置
   - 确认MQTT服务器IP正确

### 日志查看
- 系统日志: `logs/esp32_backend_YYYYMMDD.log`
- MQTT服务器日志: 控制台输出

## 开发说明

### 编译ESP32固件
```bash
cd ESP32IOT
pio run
```

### 上传固件
```bash
pio run --target upload
```

### 监控串口
```bash
pio device monitor
```

## 注意事项
1. 首次运行需要配置WiFi信息
2. 确保网络环境允许MQTT通信
3. 生产环境建议启用MQTT认证
4. 定期备份数据库文件

## 联系支持
如有问题，请检查日志文件或联系技术支持。
